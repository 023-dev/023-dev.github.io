<section class="utterances mx-auto mt-10 w-full">
    <div class="loading-msg text-center text-gray-400 py-10">
        Loading Comments...
    </div>
</section>

<script>
    const repo = "023-dev/023-dev.github.io";

    const createUtterances = (theme: string) => {
        const container = document.querySelector("section.utterances");
        if (!container) {
            console.log("Utterances container not found yet, retrying...");
            setTimeout(() => createUtterances(theme), 300);
            return;
        }

        // Prevent duplicate injection
        if (container.querySelector("script")) return;

        container.innerHTML = ""; // Clear loading message
        const script = document.createElement("script");
        script.src = "https://utteranc.es/client.js";
        script.setAttribute("repo", repo);
        script.setAttribute("issue-term", "pathname");
        script.setAttribute("label", "comment");
        script.setAttribute("theme", theme);
        script.setAttribute("crossorigin", "anonymous");
        script.async = true;
        container.appendChild(script);
    };

    const getTheme = () => {
        return document.documentElement.classList.contains("dark")
            ? "github-dark"
            : "github-light";
    };

    // Initial load
    window.addEventListener("load", () => createUtterances(getTheme()));
    // Also try immediately just in case
    createUtterances(getTheme());

    // Theme sync logic
    const updateUtterancesTheme = () => {
        const theme = getTheme();
        const iframe =
            document.querySelector<HTMLIFrameElement>(".utterances iframe");

        if (iframe) {
            const message = {
                type: "set-theme",
                theme: theme,
            };
            iframe.contentWindow?.postMessage(message, "https://utteranc.es");
        } else {
            // If iframe doesn't exist yet, try creating it (this handles late theme switches before load)
            createUtterances(theme);
        }
    };

    const observer = new MutationObserver(updateUtterancesTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
    });
</script>
